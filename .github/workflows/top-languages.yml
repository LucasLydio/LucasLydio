name: Generate Top Languages SVG

on:
  schedule:
    - cron: "15 6 * * *" # daily 06:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate top languages SVG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: LucasLydio
        run: |
          mkdir -p generated

          python3 - << 'PY'
          import os, json, urllib.request
          from collections import defaultdict
          from datetime import datetime, timezone

          token = os.environ["GH_TOKEN"]
          user = os.environ["GH_USER"]

          # GraphQL: fetch last 50 non-fork repos + language sizes
          query = """
          query($login:String!) {
            user(login:$login) {
              repositories(first: 50, orderBy: {field: UPDATED_AT, direction: DESC}, isFork: false, ownerAffiliations: OWNER) {
                nodes {
                  name
                  languages(first: 10, orderBy: {field: SIZE, direction: DESC}) {
                    edges { size node { name color } }
                  }
                }
              }
            }
          }
          """

          payload = json.dumps({"query": query, "variables": {"login": user}}).encode("utf-8")
          req = urllib.request.Request(
            "https://api.github.com/graphql",
            data=payload,
            headers={
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "User-Agent": "top-languages-svg-generator"
            },
            method="POST"
          )

          with urllib.request.urlopen(req) as resp:
            data = json.loads(resp.read().decode("utf-8"))

          if "errors" in data:
            raise SystemExit("GraphQL errors: " + json.dumps(data["errors"], indent=2))

          repos = (data.get("data", {}).get("user", {}) or {}).get("repositories", {}).get("nodes", []) or []

          totals = defaultdict(int)
          colors = {}

          for r in repos:
            langs = (r.get("languages", {}) or {}).get("edges", []) or []
            for e in langs:
              size = int(e.get("size") or 0)
              node = e.get("node") or {}
              name = node.get("name") or "Unknown"
              totals[name] += size
              if node.get("color") and name not in colors:
                colors[name] = node["color"]

          if not totals:
            # fallback card
            svg = """<svg xmlns="http://www.w3.org/2000/svg" width="820" height="220">
              <rect width="100%" height="100%" rx="22" fill="#0b1220"/>
              <text x="40" y="90" fill="#fff" font-family="ui-sans-serif,system-ui" font-size="28" font-weight="700">
                Top Languages
              </text>
              <text x="40" y="130" fill="rgba(255,255,255,0.85)" font-family="ui-sans-serif,system-ui" font-size="16">
                No data yet — push some code and re-run the workflow.
              </text>
            </svg>"""
            open("generated/top-languages.svg","w",encoding="utf-8").write(svg)
            raise SystemExit(0)

          # Top 6 languages
          top = sorted(totals.items(), key=lambda x: x[1], reverse=True)[:6]
          total_size = sum(v for _, v in top) or 1

          def pct(v): return round((v / total_size) * 100, 1)

          updated = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M UTC")

          # Dribbble-ish "glass + gradient" card
          W, H = 820, 320
          padding = 34
          card_rx = 26

          # layout
          title_y = 78
          subtitle_y = 110
          bar_x = padding
          bar_y = 140
          bar_w = W - padding*2
          bar_h = 18

          # Build segmented bar
          segs = []
          x = bar_x
          for i, (name, val) in enumerate(top):
            w = max(8, int(bar_w * (val / total_size)))
            color = colors.get(name, "#8b9bb4")
            segs.append((x, w, color))
            x += w

          # Ensure last segment ends exactly at bar end
          if segs:
            last_x, last_w, last_c = segs[-1]
            end = bar_x + bar_w
            segs[-1] = (last_x, max(8, end - last_x), last_c)

          # Legend rows
          # two columns, 3 rows
          col1_x = padding
          col2_x = W//2 + 10
          row_y0 = 190
          row_gap = 38

          def esc(s):
            return (s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")
                     .replace('"',"&quot;").replace("'","&#39;"))

          legend_items = []
          for idx, (name, val) in enumerate(top):
            col_x = col1_x if idx < 3 else col2_x
            row = idx if idx < 3 else idx - 3
            y = row_y0 + row*row_gap
            c = colors.get(name, "#8b9bb4")
            legend_items.append((col_x, y, name, pct(val), c))

          svg_parts = []
          svg_parts.append(f'''<svg xmlns="http://www.w3.org/2000/svg" width="{W}" height="{H}" viewBox="0 0 {W} {H}">
            <defs>
              <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#081018"/>
                <stop offset="55%" stop-color="#0b1630"/>
                <stop offset="100%" stop-color="#0a0f1c"/>
              </linearGradient>

              <linearGradient id="glow" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#006c70" stop-opacity="0.85"/>
                <stop offset="100%" stop-color="#f4b313" stop-opacity="0.75"/>
              </linearGradient>

              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="10" stdDeviation="14" flood-opacity="0.25"/>
              </filter>

              <filter id="blur" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="10"/>
              </filter>
            </defs>

            <!-- background -->
            <rect width="100%" height="100%" fill="url(#bg)"/>

            <!-- soft glow blobs -->
            <circle cx="135" cy="85" r="70" fill="url(#glow)" opacity="0.25" filter="url(#blur)"/>
            <circle cx="{W-140}" cy="{H-70}" r="90" fill="url(#glow)" opacity="0.20" filter="url(#blur)"/>

            <!-- glass card -->
            <g filter="url(#shadow)">
              <rect x="20" y="20" rx="{card_rx}" width="{W-40}" height="{H-40}"
                fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.12)" stroke-width="1"/>
            </g>

            <!-- title -->
            <text x="{padding}" y="{title_y}" fill="#ffffff"
              font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"
              font-size="30" font-weight="800">
              Top Languages
            </text>

            <text x="{padding}" y="{subtitle_y}" fill="rgba(255,255,255,0.78)"
              font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"
              font-size="14">
              Based on repo language sizes · Updated {updated}
            </text>

            <!-- segmented bar -->
            <rect x="{bar_x}" y="{bar_y}" rx="10" width="{bar_w}" height="{bar_h}" fill="rgba(255,255,255,0.10)"/>
          ''')

          # bar segments
          for x, w, c in segs:
            svg_parts.append(f'<rect x="{x}" y="{bar_y}" rx="10" width="{w}" height="{bar_h}" fill="{c}" opacity="0.95"/>')

          # legend
          for x, y, name, p, c in legend_items:
            svg_parts.append(f'''
              <circle cx="{x+10}" cy="{y-6}" r="6" fill="{c}"/>
              <text x="{x+24}" y="{y}" fill="#ffffff"
                font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"
                font-size="16" font-weight="700">{esc(name)}</text>
              <text x="{x+260}" y="{y}" fill="rgba(255,255,255,0.75)"
                font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"
                font-size="14" text-anchor="end">{p}%</text>
            ''')

          svg_parts.append("</g></svg>")

          svg = "\n".join(svg_parts)
          open("generated/top-languages.svg","w",encoding="utf-8").write(svg)
          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add generated/top-languages.svg
          git commit -m "chore: update top languages svg" || exit 0
          git push
