name: Generate Top Languages SVG

on:
  # ✅ Auto-update when your repos change (language sizes change after code pushes)
  push:
    branches: ["main"]

  # ✅ Also update daily (covers changes from other devices/merges)
  schedule:
    - cron: "15 6 * * *" # daily 06:15 UTC

  # ✅ Manual run button
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate top languages (GitHub-safe SVG)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: LucasLydio
        run: |
          mkdir -p generated

          python3 - << 'PY'
          import os, json, urllib.request
          from collections import defaultdict
          from datetime import datetime, timezone

          token = os.environ["GH_TOKEN"]
          user = os.environ["GH_USER"]

          # GraphQL: fetch up to 80 recent non-fork repos + language sizes
          # (More repos => more accurate and will reflect changes better)
          query = """
          query($login:String!) {
            user(login:$login) {
              repositories(first: 80, orderBy: {field: UPDATED_AT, direction: DESC}, isFork: false, ownerAffiliations: OWNER) {
                nodes {
                  name
                  languages(first: 10, orderBy: {field: SIZE, direction: DESC}) {
                    edges { size node { name color } }
                  }
                }
              }
            }
          }
          """

          payload = json.dumps({"query": query, "variables": {"login": user}}).encode("utf-8")
          req = urllib.request.Request(
            "https://api.github.com/graphql",
            data=payload,
            headers={
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "User-Agent": "top-languages-svg-generator"
            },
            method="POST"
          )

          with urllib.request.urlopen(req) as resp:
            data = json.loads(resp.read().decode("utf-8"))

          if "errors" in data:
            raise SystemExit("GraphQL errors: " + json.dumps(data["errors"], indent=2))

          repos = (data.get("data", {}).get("user", {}) or {}).get("repositories", {}).get("nodes", []) or []

          totals = defaultdict(int)
          colors = {}

          for r in repos:
            langs = (r.get("languages", {}) or {}).get("edges", []) or []
            for e in langs:
              size = int(e.get("size") or 0)
              node = e.get("node") or {}
              name = node.get("name") or "Unknown"
              totals[name] += size
              if node.get("color") and name not in colors:
                colors[name] = node["color"]

          # ✅ GitHub-safe SVG rules:
          # - no rgba() in fill/stroke (use fill-opacity/stroke-opacity)
          # - avoid feDropShadow (use classic blur+offset shadow)
          # - keep filters simple and widely supported

          def esc(s: str) -> str:
            return (s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")
                     .replace('"',"&quot;").replace("'","&#39;"))

          updated = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M UTC")

          if not totals:
            svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="820" height="220" viewBox="0 0 820 220">
              <rect width="100%" height="100%" rx="22" fill="#0b1220"/>
              <text x="40" y="90" fill="#ffffff" font-family="Delius, ui-sans-serif, system-ui" font-size="28" font-weight="700">
                Top Languages
              </text>
              <text x="40" y="130" fill="#ffffff" fill-opacity="0.85" font-family="Delius, ui-sans-serif, system-ui" font-size="16">
                No data yet — push some code and re-run the workflow.
              </text>
              <text x="40" y="160" fill="#ffffff" fill-opacity="0.55" font-family="Delius, ui-sans-serif, system-ui" font-size="12">
                Updated {updated}
              </text>
            </svg>'''
            open("generated/top-languages.svg","w",encoding="utf-8").write(svg)
            raise SystemExit(0)

          # Top 6 languages
          top = sorted(totals.items(), key=lambda x: x[1], reverse=True)[:6]
          total_size = sum(v for _, v in top) or 1

          def pct(v): return round((v / total_size) * 100, 1)

          W, H = 900, 340
          padding = 40
          card_rx = 28

          title_y = 86
          subtitle_y = 118
          bar_x = padding
          bar_y = 150
          bar_w = W - padding*2
          bar_h = 18

          # segmented bar
          segs = []
          x = bar_x
          for (name, val) in top:
            w = max(10, int(bar_w * (val / total_size)))
            c = colors.get(name, "#8b9bb4")
            segs.append((x, w, c))
            x += w
          if segs:
            last_x, last_w, last_c = segs[-1]
            end = bar_x + bar_w
            segs[-1] = (last_x, max(10, end - last_x), last_c)

          # legend layout (2 columns)
          col1_x = padding
          col2_x = W//2 + 20
          row_y0 = 205
          row_gap = 42

          legend_items = []
          for idx, (name, val) in enumerate(top):
            col_x = col1_x if idx < 3 else col2_x
            row = idx if idx < 3 else idx - 3
            y = row_y0 + row*row_gap
            c = colors.get(name, "#8b9bb4")
            legend_items.append((col_x, y, name, pct(val), c))

          # Note on font:
          # SVG cannot reliably "download" Google fonts on GitHub.
          # We provide Delius first; if GitHub doesn't have it, it falls back to system fonts.
          font_stack = "Delius, ui-rounded, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"

          svg_parts = []
          svg_parts.append(f'''<svg xmlns="http://www.w3.org/2000/svg" width="{W}" height="{H}" viewBox="0 0 {W} {H}">
            <defs>
              <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#081018"/>
                <stop offset="55%" stop-color="#0b1630"/>
                <stop offset="100%" stop-color="#0a0f1c"/>
              </linearGradient>

              <linearGradient id="glow" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#006c70" stop-opacity="0.70"/>
                <stop offset="100%" stop-color="#f4b313" stop-opacity="0.65"/>
              </linearGradient>

              <!-- GitHub-safe shadow -->
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="10" result="blur"/>
                <feOffset in="blur" dx="0" dy="10" result="offsetBlur"/>
                <feComponentTransfer in="offsetBlur" result="shadow">
                  <feFuncA type="linear" slope="0.25"/>
                </feComponentTransfer>
                <feMerge>
                  <feMergeNode in="shadow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>

              <filter id="softBlur" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="14"/>
              </filter>
            </defs>

            <!-- background -->
            <rect width="100%" height="100%" fill="url(#bg)"/>

            <!-- soft glow blobs (safe) -->
            <circle cx="170" cy="95" r="85" fill="url(#glow)" fill-opacity="0.22" filter="url(#softBlur)"/>
            <circle cx="{W-170}" cy="{H-80}" r="110" fill="url(#glow)" fill-opacity="0.18" filter="url(#softBlur)"/>

            <!-- glass card -->
            <g filter="url(#shadow)">
              <rect x="22" y="22" rx="{card_rx}" width="{W-44}" height="{H-44}"
                fill="#ffffff" fill-opacity="0.06"
                stroke="#ffffff" stroke-opacity="0.12" stroke-width="1"/>
            </g>

            <!-- title -->
            <text x="{padding}" y="{title_y}" fill="#ffffff"
              font-family="{font_stack}"
              font-size="34" font-weight="800">
              Top Languages
            </text>

            <text x="{padding}" y="{subtitle_y}" fill="#ffffff" fill-opacity="0.78"
              font-family="{font_stack}"
              font-size="14">
              Repo language sizes · Updated {updated}
            </text>

            <!-- segmented bar background -->
            <rect x="{bar_x}" y="{bar_y}" rx="10" width="{bar_w}" height="{bar_h}"
              fill="#ffffff" fill-opacity="0.10"/>
          ''')

          # segments
          for sx, sw, sc in segs:
            svg_parts.append(
              f'<rect x="{sx}" y="{bar_y}" rx="10" width="{sw}" height="{bar_h}" fill="{sc}" fill-opacity="0.95"/>'
            )

          # legend
          for lx, ly, name, p, c in legend_items:
            svg_parts.append(f'''
              <circle cx="{lx+10}" cy="{ly-7}" r="6" fill="{c}"/>
              <text x="{lx+26}" y="{ly}" fill="#ffffff"
                font-family="{font_stack}" font-size="18" font-weight="800">{esc(name)}</text>
              <text x="{lx+300}" y="{ly}" fill="#ffffff" fill-opacity="0.72"
                font-family="{font_stack}" font-size="14" text-anchor="end">{p}%</text>
            ''')

          # footer hint
          svg_parts.append(f'''
            <text x="{padding}" y="{H-28}" fill="#ffffff" fill-opacity="0.45"
              font-family="{font_stack}" font-size="12">
              Generated by GitHub Actions · {user}
            </text>
          ''')

          svg_parts.append("</svg>")
          svg = "\n".join(svg_parts)
          open("generated/top-languages.svg","w",encoding="utf-8").write(svg)
          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add generated/top-languages.svg
          git commit -m "chore: update top languages svg" || exit 0
          git push
