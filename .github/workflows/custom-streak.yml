name: Generate Custom Streak SVG

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 6 * * *" # daily 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate streak (GitHub-safe SVG)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: LucasLydio
        run: |
          mkdir -p generated

          python3 - << 'PY'
          import os, json, urllib.request
          from datetime import datetime, timezone, timedelta

          token = os.environ["GH_TOKEN"]
          user = os.environ["GH_USER"]

          # ---- Get contribution calendar via GitHub GraphQL (last ~1 year) ----
          query = """
          query($login:String!) {
            user(login:$login) {
              contributionsCollection {
                contributionCalendar {
                  weeks {
                    contributionDays {
                      date
                      contributionCount
                    }
                  }
                }
              }
            }
          }
          """

          payload = json.dumps({"query": query, "variables": {"login": user}}).encode("utf-8")
          req = urllib.request.Request(
            "https://api.github.com/graphql",
            data=payload,
            headers={
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "User-Agent": "custom-streak-svg-generator"
            },
            method="POST"
          )

          with urllib.request.urlopen(req) as resp:
            data = json.loads(resp.read().decode("utf-8"))

          if "errors" in data:
            raise SystemExit("GraphQL errors: " + json.dumps(data["errors"], indent=2))

          weeks = (
            data.get("data", {})
              .get("user", {})
              .get("contributionsCollection", {})
              .get("contributionCalendar", {})
              .get("weeks", [])
          )

          days = []
          for w in weeks:
            for d in w.get("contributionDays", []):
              days.append((d["date"], int(d["contributionCount"])))

          # ---- Compute streak (consecutive days up to today, allow timezone ambiguity by checking today & yesterday) ----
          # GitHub dates are YYYY-MM-DD; treat them as calendar days.
          today = datetime.now(timezone.utc).date()
          yesterday = today - timedelta(days=1)

          by_date = {dt: cnt for dt, cnt in days}

          def has_contrib(day):
            return by_date.get(day.isoformat(), 0) > 0

          # If no contrib today, start from yesterday (common if you haven't pushed today UTC).
          start_day = today if has_contrib(today) else yesterday

          streak = 0
          cursor = start_day
          while has_contrib(cursor):
            streak += 1
            cursor = cursor - timedelta(days=1)

          updated = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M UTC")

          # ---- GitHub-safe SVG (no rgba(), no feDropShadow) ----
          W, H = 900, 260
          padding = 40
          card_rx = 28

          font_stack = "Delius, ui-rounded, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto"

          # Small progress ring-ish bar (visual)
          # cap streak for bar to 30 for nicer visuals
          cap = 30
          progress = min(streak, cap) / cap
          bar_w = 360
          bar_h = 14
          bar_x = padding
          bar_y = 156
          fill_w = max(8, int(bar_w * progress))

          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="{W}" height="{H}" viewBox="0 0 {W} {H}">
            <defs>
              <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#081018"/>
                <stop offset="55%" stop-color="#0b1630"/>
                <stop offset="100%" stop-color="#0a0f1c"/>
              </linearGradient>

              <linearGradient id="glow" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#006c70" stop-opacity="0.70"/>
                <stop offset="100%" stop-color="#f4b313" stop-opacity="0.65"/>
              </linearGradient>

              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="10" result="blur"/>
                <feOffset in="blur" dx="0" dy="10" result="offsetBlur"/>
                <feComponentTransfer in="offsetBlur" result="shadow">
                  <feFuncA type="linear" slope="0.25"/>
                </feComponentTransfer>
                <feMerge>
                  <feMergeNode in="shadow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>

              <filter id="softBlur" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="14"/>
              </filter>
            </defs>

            <rect width="100%" height="100%" fill="url(#bg)"/>

            <circle cx="170" cy="85" r="85" fill="url(#glow)" fill-opacity="0.22" filter="url(#softBlur)"/>
            <circle cx="{W-170}" cy="{H-60}" r="110" fill="url(#glow)" fill-opacity="0.18" filter="url(#softBlur)"/>

            <g filter="url(#shadow)">
              <rect x="22" y="22" rx="{card_rx}" width="{W-44}" height="{H-44}"
                fill="#ffffff" fill-opacity="0.06"
                stroke="#ffffff" stroke-opacity="0.12" stroke-width="1"/>
            </g>

            <text x="{padding}" y="86" fill="#ffffff"
              font-family="{font_stack}" font-size="34" font-weight="800">
              Custom Streak
            </text>

            <text x="{padding}" y="118" fill="#ffffff" fill-opacity="0.78"
              font-family="{font_stack}" font-size="14">
              Consecutive days with contributions Â· Updated {updated}
            </text>

            <text x="{padding}" y="178" fill="#ffffff"
              font-family="{font_stack}" font-size="28" font-weight="900">
              {streak} day(s) ðŸ”¥
            </text>

            <!-- progress bar -->
            <rect x="{bar_x}" y="{bar_y}" rx="10" width="{bar_w}" height="{bar_h}"
              fill="#ffffff" fill-opacity="0.10"/>
            <rect x="{bar_x}" y="{bar_y}" rx="10" width="{fill_w}" height="{bar_h}"
              fill="url(#glow)"/>

            <text x="{bar_x + bar_w}" y="{bar_y + 12}" fill="#ffffff" fill-opacity="0.60"
              font-family="{font_stack}" font-size="12" text-anchor="end">
              ëª©í‘œ 30
            </text>

            <text x="{padding}" y="{H-28}" fill="#ffffff" fill-opacity="0.45"
              font-family="{font_stack}" font-size="12">
              Generated by GitHub Actions Â· {user}
            </text>
          </svg>'''

          open("generated/streak.svg","w",encoding="utf-8").write(svg)
          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add generated/streak.svg
          git commit -m "chore: update streak svg" || exit 0
          git push
